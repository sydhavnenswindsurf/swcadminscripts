<script type="text/javascript"> 
  function PageViewModel(){
     var self = this;
     this.hylder =  ko.observableArray([]);
     
     this.groupedHylder = ko.computed(function(){
        var result= [];
        _.forOwn(_.groupBy(this.hylder(),"container"), function(value, key) {
           result.push({groupName:key,values:value})
         });
        return result;
     
     },this);
     this.isCallingServer= ko.observable(false);
     this.loadHylder =function(){
          this.isCallingServer(true);
          google.script.run.withSuccessHandler(function(result){    
         
          self.updateHylder(result);
          self.isCallingServer(false);
          }).loadHylder();
     }
     this.updateHylder = function (result){
         self.hylder(result.map(function(item)
         {
            item.newOwner = ko.observable("");
            item.navn = ko.observable(item.navn);
            return item;
         }));
     }
     this.remove = function(hyldeInfo){
          if(!confirm("Dette fjerner personen fra hylden?")){
              return;
          }
          this.isCallingServer(true);
          var dataToSend=ko.mapping.toJS(hyldeInfo);
          console.log(dataToSend);
          google.script.run.withSuccessHandler(function(result){         
          
              self.updateHylder(result);
              self.isCallingServer(false);
          
          }).withFailureHandler(function(message){
          
            self.isCallingServer(false);
            alert(message);
            
          }).remove(dataToSend);
     }
     this.add = function(hyldeInfo){
          if(hyldeInfo.newOwner()==''){
              alert("Du skal udfylde med et medlems email adreese");
              return;
          }
          
          this.isCallingServer(true);
          google.script.run.withSuccessHandler(function(result){
          
              console.log(result);
              hyldeInfo.navn(result.newlyAddedNavn);
              self.isCallingServer(false);
              
          }).withFailureHandler(function(message){
            console.log(message);
            self.isCallingServer(false);
            alert("Kunne ikke tilf√∏je medlem: \n" + message);
            
          })
          .add({newOwner:hyldeInfo.newOwner(), hyldenr:hyldeInfo.hyldenr});
     }
     self.loadHylder();
  }
</script>
  




